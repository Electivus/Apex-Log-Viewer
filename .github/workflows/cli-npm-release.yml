name: CLI NPM Release

on:
  push:
    tags:
      - 'cli-v*'
  workflow_dispatch:

concurrency:
  group: cli-npm-release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

jobs:
  publish_platform:
    name: Publish CLI (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-x64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            npm_os: linux
            cpu: x64
            bin: apex-log-viewer
            native: true
          - platform: linux-arm64
            os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            npm_os: linux
            cpu: arm64
            bin: apex-log-viewer
            use_cross: true
            native: false
          - platform: darwin-x64
            os: macos-13
            target: x86_64-apple-darwin
            npm_os: darwin
            cpu: x64
            bin: apex-log-viewer
            native: true
          - platform: darwin-arm64
            os: macos-latest
            target: aarch64-apple-darwin
            npm_os: darwin
            cpu: arm64
            bin: apex-log-viewer
            native: true
          - platform: win32-x64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            npm_os: win32
            cpu: x64
            bin: apex-log-viewer.exe
            native: true
          - platform: win32-arm64
            os: windows-latest
            target: aarch64-pc-windows-msvc
            npm_os: win32
            cpu: arm64
            bin: apex-log-viewer.exe
            native: false
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js 22.x
        uses: actions/setup-node@v6
        with:
          node-version: 22.x
          registry-url: https://registry.npmjs.org/
          scope: '@electivus'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (linux arm64)
        if: ${{ matrix.use_cross == true }}
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Verify tag matches Cargo version
        shell: bash
        run: |
          set -euo pipefail
          TAG_VERSION="${GITHUB_REF_NAME#cli-v}"
          CARGO_VERSION=$(node -e "import('./scripts/cli-npm/read-version.mjs').then(m=>console.log(m.readCargoVersion('crates/cli/Cargo.toml')))" )
          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "Tag $GITHUB_REF_NAME != Cargo version $CARGO_VERSION" >&2
            exit 1
          fi

      - name: Build CLI
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ matrix.use_cross || 'false' }}" = "true" ]; then
            cross build -p apex-log-viewer-cli --release --target "${{ matrix.target }}"
          else
            cargo build -p apex-log-viewer-cli --release --target "${{ matrix.target }}"
          fi

      - name: Smoke test
        if: ${{ matrix.native == true }}
        shell: bash
        run: |
          set -euo pipefail
          BIN_PATH="target/${{ matrix.target }}/release/${{ matrix.bin }}"
          "$BIN_PATH" --help >/dev/null

      - name: Package npm platform
        shell: bash
        run: |
          set -euo pipefail
          BIN_PATH="target/${{ matrix.target }}/release/${{ matrix.bin }}"
          node scripts/cli-npm/package-platform.mjs \
            "${{ matrix.target }}" \
            "${{ matrix.platform }}" \
            "${{ matrix.npm_os }}" \
            "${{ matrix.cpu }}" \
            "${{ matrix.bin }}" \
            "$BIN_PATH" \
            "dist/cli-npm"

      - name: Ensure NPM token is set
        shell: bash
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "$NPM_TOKEN" ]; then
            echo "NPM_TOKEN is required to publish" >&2
            exit 1
          fi

      - name: Publish npm platform package
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          cd "dist/cli-npm/${{ matrix.platform }}"
          npm publish --access public --provenance

  publish_wrapper:
    name: Publish CLI Wrapper
    needs: publish_platform
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js 22.x
        uses: actions/setup-node@v6
        with:
          node-version: 22.x
          registry-url: https://registry.npmjs.org/
          scope: '@electivus'

      - name: Verify tag matches Cargo version
        shell: bash
        run: |
          set -euo pipefail
          TAG_VERSION="${GITHUB_REF_NAME#cli-v}"
          CARGO_VERSION=$(node -e "import('./scripts/cli-npm/read-version.mjs').then(m=>console.log(m.readCargoVersion('crates/cli/Cargo.toml')))" )
          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "Tag $GITHUB_REF_NAME != Cargo version $CARGO_VERSION" >&2
            exit 1
          fi

      - name: Package npm wrapper
        shell: bash
        run: |
          set -euo pipefail
          node scripts/cli-npm/package-wrapper.mjs \
            "dist/cli-npm" \
            linux-x64 linux-arm64 darwin-x64 darwin-arm64 win32-x64 win32-arm64

      - name: Ensure NPM token is set
        shell: bash
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "$NPM_TOKEN" ]; then
            echo "NPM_TOKEN is required to publish" >&2
            exit 1
          fi

      - name: Publish npm wrapper package
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          cd "dist/cli-npm/wrapper"
          npm publish --access public --provenance
