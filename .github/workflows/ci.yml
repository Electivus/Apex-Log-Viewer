name: CI

on:
  push:
    # Trunk-based: run CI on any branch (no packaging here)
    branches:
      - '**'
  pull_request:
  workflow_dispatch:
    inputs:
      scope:
        description: "Optional test scope (unit|integration|all)"
        required: false
        default: unit
        type: choice
        options:
          - unit
          - integration
          - all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Principle of least privilege for GITHUB_TOKEN
permissions:
  contents: read

jobs:
  build_and_test:
    name: Build and Test (Node ${{ matrix.node }} â€¢ ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        node: ['22.x']
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build (type-check + lint + bundle)
        run: npm run build

      - name: Run tests
        run: |
          case "${{ github.event.inputs.scope || 'unit' }}" in
            unit) npm run test:unit:ci ;;
            integration) npm run test:integration:ci ;;
            all) npm run test:ci ;;
            *) npm run test:unit:ci ;;
          esac

  smoke_vsix:
    name: VSIX Smoke Test
    needs: build_and_test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Node.js 22.x
        uses: actions/setup-node@v6
        with:
          node-version: 22.x
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Build and run VSIX smoke
        run: npm run test:smoke:vsix
        env:
          ALWAYS_SMOKE_VSIX: "1"
